{% extends 'librarian/base.html' %}

{% block page_title %}Laporan{% endblock %}

{% block librarian_content %}
<!-- Page Header -->
<div class="mb-4">
    <h2 class="fw-bold">
        <i class="bi bi-file-earmark-text text-primary"></i> Pusat Laporan
    </h2>
    <p class="text-muted">Generate laporan dalam format PDF atau Excel untuk Kepala Sekolah</p>
</div>

<!-- Report Cards -->
<div class="row g-4">
    <!-- Laporan Peminjaman -->
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                        <i class="bi bi-arrow-repeat text-primary" style="font-size: 2rem;"></i>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Laporan Peminjaman</h5>
                        <small class="text-muted">Data peminjaman buku dengan filter tanggal</small>
                    </div>
                </div>
                
                <form method="get" action="{% url 'reports:loan_pdf' %}" class="mb-3" id="loanForm">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small">Tanggal Mulai</label>
                            <input type="date" class="form-control form-control-sm" name="start_date">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Tanggal Akhir</label>
                            <input type="date" class="form-control form-control-sm" name="end_date">
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Status</label>
                            <select class="form-select form-select-sm" name="status">
                                <option value="">Semua Status</option>
                                <option value="dipinjam">Dipinjam</option>
                                <option value="terlambat">Terlambat</option>
                                <option value="dikembalikan">Dikembalikan</option>
                            </select>
                        </div>
                    </div>
                </form>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-danger" onclick="downloadReport('loan', 'pdf')">
                        <i class="bi bi-file-pdf"></i> Download PDF
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadReport('loan', 'excel')">
                        <i class="bi bi-file-excel"></i> Download Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Laporan Statistik Bulanan -->
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                        <i class="bi bi-graph-up text-warning" style="font-size: 2rem;"></i>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Laporan Statistik Bulanan</h5>
                        <small class="text-muted">Statistik peminjaman per bulan (Tahun Ajaran)</small>
                    </div>
                </div>
                
                <form method="get" action="{% url 'reports:monthly_pdf' %}" class="mb-3" id="monthlyForm">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="form-label small">Tahun Ajaran</label>
                            <select class="form-select form-select-sm" name="academic_year" id="academicYear">
                                <!-- Options akan di-generate oleh JavaScript -->
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Bulan</label>
                            <select class="form-select form-select-sm" name="month" id="monthSelect">
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                            </select>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                Juli-Desember = Semester 1, Januari-Juni = Semester 2
                            </small>
                        </div>
                    </div>
                </form>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-danger" onclick="downloadReport('monthly', 'pdf')">
                        <i class="bi bi-file-pdf"></i> Download PDF
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadReport('monthly', 'excel')">
                        <i class="bi bi-file-excel"></i> Download Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Laporan Anggota -->
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-success bg-opacity-10 rounded-circle p-3 me-3">
                        <i class="bi bi-people text-success" style="font-size: 2rem;"></i>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Laporan Anggota</h5>
                        <small class="text-muted">Data anggota perpustakaan aktif</small>
                    </div>
                </div>
                
                <p class="text-muted small mb-3">
                    Laporan berisi data lengkap semua anggota perpustakaan yang masih aktif.
                </p>
                
                <div class="d-grid gap-2">
                    <a href="{% url 'reports:member_pdf' %}" class="btn btn-danger">
                        <i class="bi bi-file-pdf"></i> Download PDF
                    </a>
                    <a href="{% url 'reports:member_excel' %}" class="btn btn-success">
                        <i class="bi bi-file-excel"></i> Download Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Laporan Buku -->
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-info bg-opacity-10 rounded-circle p-3 me-3">
                        <i class="bi bi-book text-info" style="font-size: 2rem;"></i>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Laporan Buku</h5>
                        <small class="text-muted">Data koleksi buku perpustakaan</small>
                    </div>
                </div>
                
                <p class="text-muted small mb-3">
                    Laporan berisi data lengkap semua buku dan ketersediaannya.
                </p>
                
                <div class="d-grid gap-2">
                    <a href="{% url 'reports:book_pdf' %}" class="btn btn-danger">
                        <i class="bi bi-file-pdf"></i> Download PDF
                    </a>
                    <a href="{% url 'reports:book_excel' %}" class="btn btn-success">
                        <i class="bi bi-file-excel"></i> Download Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Laporan Denda -->
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-danger bg-opacity-10 rounded-circle p-3 me-3">
                        <i class="bi bi-cash-coin text-danger" style="font-size: 2rem;"></i>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Laporan Denda</h5>
                        <small class="text-muted">Data denda keterlambatan</small>
                    </div>
                </div>
                
                <p class="text-muted small mb-3">
                    Laporan berisi data peminjaman yang terkena denda keterlambatan.
                </p>
                
                <div class="d-grid gap-2">
                    <a href="{% url 'reports:fine_pdf' %}" class="btn btn-danger">
                        <i class="bi bi-file-pdf"></i> Download PDF
                    </a>
                                        <a href="{% url 'reports:fine_excel' %}" class="btn btn-success">
                        <i class="bi bi-file-excel"></i> Download Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Info Box -->
<div class="card mt-4 border-primary">
    <div class="card-body">
        <h6 class="card-title">
            <i class="bi bi-info-circle text-primary"></i> Informasi
        </h6>
        <ul class="mb-0">
            <li>Laporan akan otomatis ter-download setelah Anda klik tombol</li>
            <li>Format PDF cocok untuk dicetak dan dipresentasikan</li>
            <li>Format Excel cocok untuk analisis data lebih lanjut</li>
            <li>Semua laporan sudah terformat rapi dan siap diserahkan ke Kepala Sekolah</li>
        </ul>
    </div>
</div>

<script>
// Function untuk download report dengan filter
function downloadReport(type, format) {
    let url = '';
    let formData = '';
    
    if (type === 'loan') {
        const form = document.getElementById('loanForm');
        const formDataObj = new FormData(form);
        const params = new URLSearchParams(formDataObj);
        formData = params.toString();
        
        if (format === 'pdf') {
            url = "{% url 'reports:loan_pdf' %}?" + formData;
        } else {
            url = "{% url 'reports:loan_excel' %}?" + formData;
        }
    } else if (type === 'monthly') {
        const form = document.getElementById('monthlyForm');
        const formDataObj = new FormData(form);
        const params = new URLSearchParams(formDataObj);
        formData = params.toString();
        
        if (format === 'pdf') {
            url = "{% url 'reports:monthly_pdf' %}?" + formData;
        } else {
            url = "{% url 'reports:monthly_excel' %}?" + formData;
        }
    }
    
    // Open in new tab
    window.open(url, '_blank');
}

// Generate academic years
function generateAcademicYears() {
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1; // 1-12
    
    const select = document.getElementById('academicYear');
    
    // Generate 5 tahun ajaran (2 tahun lalu sampai 3 tahun ke depan)
    for (let i = -2; i <= 3; i++) {
        const yearStart = currentYear + i;
        const yearEnd = yearStart + 1;
        const option = document.createElement('option');
        option.value = `${yearStart}/${yearEnd}`;
        option.textContent = `${yearStart}/${yearEnd}`;
        
        // Set current academic year as selected
        if (currentMonth >= 7) {
            // Juli - Desember: tahun ajaran sekarang
            if (yearStart === currentYear) {
                option.selected = true;
            }
        } else {
            // Januari - Juni: tahun ajaran dimulai tahun lalu
            if (yearStart === currentYear - 1) {
                option.selected = true;
            }
        }
        
        select.appendChild(option);
    }
}

// Set default values
document.addEventListener('DOMContentLoaded', function() {
    // Generate academic years
    generateAcademicYears();
    
    // Set current month
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    
    const monthSelect = document.getElementById('monthSelect');
    if (monthSelect) {
        monthSelect.value = currentMonth;
    }
});
</script>
{% endblock %}
